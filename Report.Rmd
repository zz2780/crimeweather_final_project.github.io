---
title: "Report"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: journal
---
```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(modelr)
library(ggplot2)
library(viridis)
library(car)
library(dplyr)

knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = F,
  echo = T,
  warning = F,
  cache = F
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 3
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)
```

```{r include = FALSE}
crime_df <- read.csv("data/crime_df.csv")

weather <- read.csv("data/weather.csv")

new_crime_df = crime_df %>%
  group_by(date,mon,day_of_week)%>%
  summarize(
    total_crime = n(),
    ) 


crime_weather = merge(new_crime_df, weather, by = "date")
crime_weather <- crime_weather %>%
  mutate(
    month = factor(mon)
  )

new_crime_df = crime_df %>%
  group_by(date,mon,day_of_week)%>%
  summarize(
    total_crime = n(),
    ) 
```
## Motivation
Based on the Lombroso’s Theory of Crime, natural climatic factors can influence crime rates. The Extreme temperatures sap one’s energy and reduce the passion for crime. The suitable temperatures stimulate one’s nerve like alcohol and makes it easier to commit criminal acts in an excited situation.

In fact, the weather in criminology covers many aspects. Apart from the weather itself, it also involves the seasons as well as the temperature. All of these natural events occur in the spatial and temporal dimensions and recur with regularity from year to year constitutes a season. In order to fully discuss the changes of crime rates in the time dimension, we also consider the changes in crime rates at different times of the day and on different days of the week.


## Initial Questions
* Is frequency of crimes associated with temperature of the day?
* Is frequency of crimes associated with precipitation/snowfall of the day?
* Do different times of the day and days of the week have an impact on the association above?

## Data

In Our project, there are two datasets, including NYPD Complaint Data Historic 
and weather data.  We obtained crime data in New York City from NYC Open Data
* Crime data of New York City is downloaded from the link below :
[NYPD Complaint Data Historic](https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i).

This dataset contains 780 million felony, misdemeanor, and violation crimes 
reported to the New York City Police Department (NYPD) from 1910 to 2021. Each 
record contains detailed information of a single crime reported to NYPD. 
In our project, we select the records from 2016-01-01 to 2017-12-31 to do 
analysis and modeling.

For further analysis, we converted the original dataset to make it more readable
and  selected some key variables:

  * `date`. Date the crime occurs.
  * `hour_of_day`. Occurring time of the crimes
  * `borough`. Borough the crime occurs.
  * `level`. Level of offense: felony, misdemeanor, violation.
  * `offense`. Description of offense.
  * `offense_classification`. Description of internal classification of offense.
  * `place`. Specific description of premises; grocery store, residence,street, etc.
  * `suspect_age`. Suspect’s Age Group.
  * `suspect_race`. Suspect’s Race Description.
  * `suspect_sex`. Suspect’s Sex Description.
  * `victim_age`. Victim’s Age Group.
  * `victim_race`. Victim’s Race Description.
  * `victim_sex`. Victim’s Sex Description.
  * `day_of_week`. Day of week that a crime occurs.
  * `mon`. Months in a year that a crime occurs.
  * `latitude`. Latitude of the place the crime occurs.
  * `longitude`. Longitude of the place the crime occurs.

Considering that weather may be a reason of committing crime, we used data from 
three weather stations in New York and calculate the mean weather parameters to 
represent the weather of New York.

Weather data is obtained from website of [NOAA](https://www.ncei.noaa.gov/metadata/geoportal/rest/metadata/item/gov.noaa.ncdc:C00861/html)

The key variables of weather are:

  * `mean_snow`. snow depth(mm).
  * `mean_prcp`. precipitation(tenths of mm)
  * `mean_tmin`. minimum temperature of a day
  * `mean_tmax`. maximum temperature of a day


## Exploratory Analysis
Based on some publicly available information, we knew that weather affect crime rate. 
For example, the hotter the weather is, the more likely people are to commit crimes. 
The worse the weather is, the less likely people are to go out and commit crimes. 
Here we want to predict number of crimes each day in New York as our outcome. And the precipitation, 
snow depth, maximum temperature and minimum temperature can be considered as predictors.

We first checked the distribution of number of crime cases each day in New York.
```{r}
ggplot(data = crime_weather,aes(x = total_crime)) + geom_histogram()+ 
  labs(title = "The distribution of daily cases", 
       y = "Counts", 
       x = "Number of crimes per day")+
  theme(plot.title = element_text(hjust = 0.5))
```

The distribution of daily cases is approximately normally distributed, thus we do not need to transform the value of the outcome.

Then, we use scatter plot to investigate the association between weather and cases/crime.

```{r}
ggplot(crime_weather, aes(x = mean_tmax, y = total_crime)) + geom_point()+    labs(title = "The Association between Max temperatures and reported crime", 
       y = "Total Crime reported", 
       x = "Max temperatures of a day")+
    theme(plot.title = element_text(hjust = 0.5))


ggplot(crime_weather, aes(x = mean_tmin, y = total_crime)) + geom_point()+    labs(title = "The Association between Min temperatures and reported crime", 
       y = "Total Crime reported", 
       x = "Min temperatures of a day")+
    theme(plot.title = element_text(hjust = 0.5))


ggplot(crime_weather, aes(x = mean_prcp, y = total_crime)) + geom_point()+    labs(title = "The Association between precipitation and reported crime",
       y = "Total Crime reported", 
       x = "Precipitation(tenths of mm)")+
    theme(plot.title = element_text(hjust = 0.5))


ggplot(crime_weather, aes(x = mean_snow, y = total_crime)) + geom_point()+    labs(title = "The Association between snowfall and reported crime",
       y = "Total Crime reported", 
       x = "Snow depth(mm)")+
    theme(plot.title = element_text(hjust = 0.5))
```
 
From the plots, we noticed that all of the four predictors may have association 
with the number of cases of crime in New York. Association between crimes and min/max temperature have a more 
obvious linear trend, whereas that between crimes and precipitation and snow depth have a less obvious trend.

We also want to investigate whether the month and day of week can be predictors.
```{r}
# Crime numbers by month

crime_month = new_crime_df %>% 
     group_by(mon) %>%
     summarize(mean_total_crimes = mean(total_crime)) %>%
                 rename(month = mon) %>% 
                 mutate(month = as.character(month))
 
mp = ggplot(crime_month,
        aes(x = month, y = mean_total_crimes, fill = month)) +
   geom_col(fill = "lightblue",colour = "steelblue") +
   geom_text(aes(label = round(mean_total_crimes)), vjust = -0.5, size=3 ) +
   labs(x="Month", 
        y="Number of Crimes",
        title = "Average Total Number of Crimes 
        By Month In 2016 & 2017")+
   scale_x_discrete(limits=crime_month$month)+
   theme_bw()+
   theme(legend.position = "off", plot.title=element_text(hjust=0.5))
 
mp

#Crime and weekdays

crime_weekday = new_crime_df %>% 
  group_by(day_of_week) %>% 
  summarise(mean_crime = round(mean(total_crime),0)) %>% 
  mutate(char = case_when(day_of_week == "Monday" ~ 01, 
                          day_of_week == "Tuesday" ~ 02,
                          day_of_week == "Wednesday" ~ 03, 
                          day_of_week == "Thursday" ~ 04,
                          day_of_week == "Friday" ~ 05,
                          day_of_week == "Saturday" ~ 06,
                          day_of_week == "Sunday" ~ 07)) %>%
  arrange(char) %>% select(-char)

weekday = ggplot(crime_weekday,
       aes(x = day_of_week, y = mean_crime, fill = day_of_week, alpha=0.2)) +
  geom_col() +
  geom_text(aes(label = mean_crime), vjust = -0.5) + 
  labs(x="Day of Week", 
       y="Number of Crimes",
       title = "Average Total Number of Crimes
       Each Week In 2016 & 2017") +
  scale_x_discrete(limits=crime_weekday$day_of_week) +
  theme_bw() +
  theme(legend.position = "off", plot.title=element_text(hjust=0.5))
  
weekday

#Crime and hours

crime_hour = crime_df %>%
  group_by(date,mon,day_of_week, hour_of_day)%>%
  summarize(
    total_crime = n(),
    ) %>%
  group_by(hour_of_day) %>% 
  summarize(mean_crime = mean(total_crime))

crime_hour_plot = ggplot(crime_hour,
       aes(x = hour_of_day, y = mean_crime, fill = hour_of_day, alpha=0.2)) +
  geom_col(fill = "plum4", colour = "powderblue") +
  labs(x="Hour of Day", 
       y="Average Number of Crimes",
       title = "Average Total Number of Crimes In 24 Hours
        Per Day In 2016 & 2017") +
  scale_x_discrete(limits=crime_hour$hour_of_day) +
  theme_bw() +
  theme(legend.position = "off", plot.title=element_text(hjust=0.5))
  
crime_hour_plot

```





## Statistical Analysis

#### Statistical test
We want to explore more on our data. So we conducted some statistical test.
First, we conducted a Chi-squared test on year and number of cases each month to 
check whether the distribution of number of cases per month is different between
the two years. The result shows that there is a significant difference of 
distribution between the two years. 

And then we want to investigate whether weather is a significant factor on number 
of crime cases. We combine the two dataset and create a categorical variable 
according to the weather parameters each day and devided them into four types:
"rainy and snowy", "snowy", "rainy", "not rainy or snowy". After that, we 
conducted a ANOVA test between number of crimes per day and weather. From the 
result, we came to conclude that the the average number of crimes per day is 
significantly different in different weather. 

We also conducted a Chi-squared test on number of different types of crimes and 
weather. We learned from the result that there is not a homogeneity in the types 
of crimes for each type of weather. So we conclude that weather may also has an 
association with the type of crimes.

#### Modeling

We already know that weather may influence crimes from previous analysis. So we 
decided to build a model to predict daily crimes cases. We proposed following
models:

* Model1: total_crime ~  day_of_week + mean_tmax + mean_prcp + mean_snow
* Model2: total_crime ~ month +day_of_week +  mean_tmax + mean_prcp + mean_snow
* Model3: total_crime ~  month +day_of_week +  mean_tmax + mean_prcp + mean_snow + mean_tmax*day_of_week
* Model4: total_crime ~ mean_tmax + mean_prcp + mean_snow

We use cross validation to compare the four models and performed a diagnostics 
and we concluded that Model3 is the best and it meet the model assumptions. 
We should select month, day of week, maximum temperature, precipitation, snow depth 
and a interaction term between temperature as our predictors.



## Discussion

