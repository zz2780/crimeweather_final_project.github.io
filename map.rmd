---
title: "Crime map"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: journal
---

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(readxl)
library(lubridate)

knitr::opts_chunk$set(
  fig.width = 10,
  fig.asp = .2,
  out.width = "90%",
  dpi = 300
)
```


```{r, message=FALSE, warning=FALSE}
#read crime_df data
crime_df = read_csv("data/crime_df.csv")
head(crime_df)

#define crime_df_map for our map
crime_df_map = drop_na(crime_df, latitude)
```

# Map draft

```{r, message=FALSE}
crime_plot =
  crime_df %>% 
  filter(!is.na(borough)) %>%
  plot_ly(
    lat = ~latitude, 
    lon = ~longitude, 
    frame = ~hour_of_day,
    type = "scattermapbox", 
    mode = "markers", 
    alpha = 0.2,
    color = ~borough) %>% 
  layout(
    mapbox = list(
      style = 'carto-positron',
      zoom = 9,
      center = list(lon = -73.9, lat = 40.7)))
crime_plot
```

# Map based on zipcodes

```{r}
library(sp) # for analyzing spatial data
library(rgdal) # for importing zips shapefile and transform CRS
```

## Get the zip codes

```{r}
#import zips shapefile and transform CRS 
zips <- readOGR("cb_2015_us_zcta510_500k/cb_2015_us_zcta510_500k.shp")
zips <- spTransform(zips, CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
```

```{r}
#extract only lon and lat
crime_lat_long = select(crime_df_map, longitude, latitude)

#transform coordinates into a SpatialPointsDataFrame
crime_spdf = SpatialPointsDataFrame(coords = crime_lat_long, data = crime_lat_long, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

#subset only the zipcodes in which points are found
crime_zips <- zips[crime_spdf, ]

#redefine crime_df_map to include zipcodes
crime_df_map = cbind(crime_df_map, over(crime_spdf, crime_zips[,"ZCTA5CE10"]))
crime_df_map = rename(crime_df_map, zip_code = ZCTA5CE10)
```

## Modified zip code

In order to make meaningful data analysis, we want zip codes represent regions with similar population. However, some zip code regions are very small, among which there are even some buildings that have their own zip codes. To deal with the challenges of zip codes, we convert zip codes to modified zip codes to account for discrepancies in population size. Modified zip codes represent regions with similar population size. In order to make the conversion, we use a conversion table `ZCTA-to-MODZCTA.csv` obtained from [here]( https://github.com/nychealth/coronavirus-data/blob/master/Geography-resources/ZCTA-to-MODZCTA.csv).

```{r}
zcta_conv = read_csv("data/ZCTA-to-MODZCTA.csv")
zcta_conv$ZCTA <- as.character(zcta_conv$ZCTA)
zcta_conv$MODZCTA <- as.character(zcta_conv$MODZCTA)
```

```{r}
# Convert zip_code to mod_zip_code
crime_df_map = crime_df_map %>%
  left_join(rename(zcta_conv, zip_code = ZCTA), by = "zip_code") %>%
  rename(mod_zip_code = MODZCTA)
```





